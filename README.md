# ArduinoABC
 
Модуль ArduinoABC и библиотека ArduinoLibrary разработаны для добавления в язык программирования [PascalABC.NET](http://www.pascalabc.net) возможности управления микронтроллером Arduino. ArduinoABC работает только в online-режиме, когда программа на PascalABC.NET поддерживает постоянную связь с Arduino. Для общения с микроконтроллером, библиотека использует протокол Firmata.

Обучающая презентация доступна по [ссылке](https://drive.google.com/drive/u/0/folders/1bRMrIQpJXWWe6LK-tJbSIBshCki7jP4e).

## Подключение
Для начала работы необходимо подключить микроконтроллер Arduino с помощью USB-кабеля к компьютеру. В случае ручного ввода номера COM-порта в пользовательской программе необходимо узнать его в диспетчере устройств (Панель управления -> Диспетчер устройств -> Порты (COM и LPT)-> Arduino). В случае использования режима автоматического поиска соединения, диспетчер устройств не нужен. Модуль подключается ключевым словом uses.

## Загрузка программы в Arduino

Для работы с микроконтроллером Arduino используя модуль ArduinoABC, в микроконтроллер должна быть загружена программа Standard-Firmata.
Это можно сделать используя системы Arduino IDE, или через встроенный в модуль метод Arduino.UploadBoard(‘auto’, ‘COM4’); Важно, что метод статический и должен выполнять еще до создания экземпляра класса. При желании можно загрузить любую другую программу на микроконтроллер, просто указав путь к ней в качестве строкового аргумента вместо ‘auto’.

```pascal
// Подключение модуля
uses ArduinoABC;
```

## Установка соединения и выбор режима работы
Для установки соединения необходимо создать экземпляр класса Arduino. При явной передачи конструктору класса имя COM-порта в виде строки будет установлено соединение по указанному порту. Если вызвать конструктор без аргументов, поиск соединения будет выполнен автоматически.
Перед отправкой управляющих команд на микроконтроллер необходимо в обязательном порядке явно установить режим входа/выхода. Без указания режима, модуль AdruinoABC будет выдавать ошибку режима (только в случае включения функции ведения лога), а управляющая команда отправлена не будет. Задание режима производится через метод SetPinMode эскземпляра класса Arduino.

```pascal
begin
//Инициализация экземпляра 
Arduino var myUno := new Arduino('COM4');
//Установка режимов входов/выходов 
myUno.SetPinMode(ledPin, PinMode.DigitalOutput);
```
#### Возможные режимы:
```pascal
static public enum PinMode
{
   DigitalInput,
   Dig italOutput,
   AnalogInput,
   AnalogOutput
}
```

## Управление дискретными выходами
Для управления дискретными выходами (например включения светодиода на 100% яркости, подачу звукового сигнала, включение силового реле для управления настольной лампой) необходимо использовать процедуру DigitalWrite, подавая ей в качестве аргументов номер дискретного выхода (integer) и желаемое состояние (boolean). В листинге показан пример программы, бесконечно включающей и выключающей выход No13. Системные
паузы управляются средствами языка PascalABC.NET.

```pascal
uses ArduinoABC;
const
///Номер пина, к которому подключен светодиод
ledPin = 13;
///Задержка между включением и выключением в мс.
delay = 500;
begin
 //Инициализация экземпляра Arduino
 var myUno := new Arduino('COM4'); //Установка режимов входов/выходов
 myUno.SetPinMode(ledPin, DigitalOutput);
 while (true) do
 begin
  myUno.DigitalWrite(ledPin, true); Sleep(delay); myUno.DigitalWrite(ledPin, false); Sleep(delay);
 end; 
end.
```


## Управление аналоговыми выходами
Для управления аналоговыми выходами (например плавное включение светодиода не на полную яркость, управление сервоприводом, управление скоростью электромотора) необходимо использовать процедуру AnalogWrite, подавая ей в качестве аргументов номер дискретного выхода (integer) и желаемое состояние (integer). В листинге показан пример программы, бесконечно плавно включающей и выключающей выход No11. 

*Важно! Только выходы №3, 5, 6, 9, 10, 11 поддерживают аналоговый режим.*
```pascal

uses ArduinoABC;
const
///Номер пина, к которому подключен светодиод
ledPin = 11;
///Задежрка между изменением яркости в мс.
delay = 2;
begin
  //Инициализация экземпляра Arduino
 var myUno := new Arduino('COM4', 10, true); //Установка режимов входов/выходов
 myUno.SetPinMode(ledPin, AnalogOutput);
   while (true) do
   begin
     //Плавное увеличение яркости
     for var i := 0 to 255 do begin
      myUno.AnalogWrite(ledPin, i);
      Sleep(delay);
     end;
     //Плавное уменьшение яркости
     for var i := 255 downto 0 do begin
      myUno.AnalogWrite(ledPin, i);
      Sleep(delay);
     end;
 end; 
end.
```

## Чтение дискретных входов
Для чтения дискретных входов (например положение тактовой кнопки) необходимо использовать функцию DigitalRead, подавая ей в качестве аргументов номер дискретного входа (integer). Возвращаемый результатов функции DigitalRead является логическим (bolean), где true обозначает наличие напряжения, а false - отсутствие. В листинге показан пример программы, постоянно выводящее на экран положение тактовой кнопки, подключенной к входу №8.
```pascal
uses ArduinoABC;
const
///Номер пина, к которому подключена кнопка
buttonPin = 8; begin
  //Инициализация экземпляра Arduino
var myUno := new Arduino(‘COM4'); //Установка режимов входов/выходов myUno.SetPinMode(buttonPin, DigitalInput); while (true) do
begin
Print(‘Кнопка ’);
if (myUno.DigitalRead(buttonPin)) then
      print(‘нажата’)
    else
      print(‘не нажата’);
  end;
```

## Чтение аналоговых входов
Для чтения аналоговых входов (например положение джойстика или значение множества датчиков) необходимо использовать функцию AnalogRead, подавая ей в качестве аргументов номер дискретного входа (integer). Возвращаемый результатов функции AnalogRead является целочисленным (integer) обозначающий входное напряжение. Диапазон (0..5) вольт транслируется в диапазон возвращаемого значения (0..1024).
В листинге показан пример программы, осуществляющей управление шариком на экране по движению джойстика, подключенного к 0 и 1 аналоговому входу.
```pascal
uses WPFObjects, ArduinoABC;

const
  scale = 0.5;
  xPin = 0;
  yPin = 1;
  buttonPin = 7;

//Инициализация экземпляра Arduino
var
  myUno := new Arduino('COM4');

//  Парсинг строки вида "511;400;1;" - координаты джойстика и статус кнопки
function GetJoyStickState() : (real, real, boolean);
begin
  
  Result := (real(myUno.AnalogRead(xPin)), 
             real(myUno.AnalogRead(yPin)),
             myUno.DigitalRead(buttonPin));
end;

begin

  myUno.setpinmode(xPin, AnalogInput);
  myUno.setpinmode(yPin, AnalogInput);
  myUno.setpinmode(buttonPin, DigitalInput);
  
  var Ball := CircleWPF.Create(100, 100, 25, Colors.Red);
  
  var (zeroX, zeroY, btnState) := GetJoyStickState();
  //  Первую порцию данных используем для инициализации нулевого положения
  zeroX := scale * zeroX - Window.Center.X;
  zeroY := scale * zeroY - Window.Center.Y;
  //  В цикле принимаем данные, и двигаем объект.
  while true do
  begin
    var x, y: real;
      //  Принимаем текущее положение джойстика
    (x, y, btnState) := GetJoyStickState();
      //  Двигаем объект
    Ball.MoveTo( scale * (1024 - x) - zeroX, scale * y - zeroY);
    if btnState then Ball.Color := RandomColor;
  end;
end.
```

## События и обработчики
Для обработки событий изменения состояния аналогово входа предусмотрен механизм событий и обработчиков. В классе Arduino существует делегат (переменная событие) onAnalogPinChanged, к которой необходимо привязать собственный обработчик. Обработчик будет вызван автоматически, а номер входа и его состояние будут переданы
обработчику в качестве аргументов.
В листинге приведен пример реализации обработчика, который выводит в консоль информацию о новом состоянии аналогово входа при
каждом его изменении.

```pascal
uses ArduinoABC;
//Обработчик события нажатия на кнопку
procedure MyUno_onAnalogPinChanged(sender: Arduino; pin: integer; value: integer);
begin
 WritelnFormat('Вход {0} поменял свое значение на {1}', pin, value);
end;
begin
 //Инициализация экземпляра Arduino
 //прямо в секции объявления переменных
 var myUno := new Arduino('COM4');
 //Установка режима аналогово входа для всех пинов (контактов) for var i := 0 to 5 do
 myUno.SetPinMode(i, Arduino.PinMode.AnalogInput);
 //Привязка обработчика к событию myUno.onAnalogPinChanged += MyUno_onAnalogPinChanged;
   //Бесконечный цикл для корректной работы событий
 while (true) do 

end.
```
